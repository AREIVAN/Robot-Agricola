<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Robot</title>

  <!-- Leaflet (mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js (grÃ¡ficas) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    #map { height: 420px; border-radius: 12px; }
    .card { padding: 12px; border: 1px solid #ddd; border-radius: 12px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h2>Dashboard Robot AgrÃ­cola</h2>
<div class="card" style="margin-bottom:16px;">
  <h3>Estado del robot</h3>
  <div style="display:flex; gap:18px; flex-wrap:wrap; align-items:center;">
    <div><b>Estado:</b> <span id="robotState">â€”</span></div>
    <div><b>Ãšltima actualizaciÃ³n:</b> <span id="lastUpdate">â€”</span></div>
    <div><b>GPS:</b> <span id="gpsState">â€”</span></div>
    <div><b>SatÃ©lites:</b> <span id="gpsSats">â€”</span></div>
    <div><b>HDOP:</b> <span id="gpsHdop">â€”</span></div>
  </div>
</div>

  <div class="grid">
    <div class="card">
      <h3>Mapa</h3>
      <div id="map"></div>
      <p id="status">Cargandoâ€¦</p>
    </div>

    <div class="card">
      <h3>Temperatura / Humedad</h3>
      <canvas id="thChart"></canvas>
    </div>
  </div>

<script>
  // === CONFIG ===
  const CHANNEL_ID = 3200807;
  const READ_KEY   = "CZ108T3YGUBC67J3";
  const RESULTS    = 200;         // puntos para ruta e histÃ³rico
  const REFRESH_MS = 15000;       // no bajes de 15s (ThingSpeak free)

  const FEEDS_URL = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_KEY}&results=${RESULTS}`;
  const LAST_URL  = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last.json?api_key=${READ_KEY}`;

  // === MAPA ===
  const map = L.map('map').setView([19.4326, -99.1332], 18);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 }).addTo(map);

  let marker = null;
  let polyline = null;

  // === CHART ===
  const ctx = document.getElementById('thChart');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Temp (Â°C)', data: [] },
        { label: 'Hum (%)', data: [] },
      ]
    },
    options: {
      responsive: true,
      animation: false
    }
  });

  function parseNum(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;

  }
function gpsQualityFromHdop(hdop) {
  if (!Number.isFinite(hdop)) return {label:"SIN DATO", color:"#999"};
  if (hdop <= 1.5) return {label:"EXCELENTE", color:"#22c55e"};
  if (hdop <= 3.0) return {label:"BUENA", color:"#eab308"};
  return {label:"MALA", color:"#ef4444"};
}

  async function loadFeeds() {
    const r = await fetch(FEEDS_URL);
    if (!r.ok) throw new Error("No pude leer feeds");
    const data = await r.json();
    return data.feeds || [];
  }

  async function loadLast() {
    const r = await fetch(LAST_URL);
    if (!r.ok) throw new Error("No pude leer last");
    return await r.json();
  }

  function updateMapRoute(feeds) {
    // Field3=lat, Field4=lon
    const points = feeds
      .map(f => [parseNum(f.field3), parseNum(f.field4)])
      .filter(([lat, lon]) => lat && lon && !(lat === 0 && lon === 0));

    if (points.length === 0) return;

    const last = points[points.length - 1];

    if (!marker) marker = L.marker(last).addTo(map);
    else marker.setLatLng(last);

    if (polyline) polyline.remove();
    polyline = L.polyline(points, { weight: 3 }).addTo(map);

    map.setView(last, 19);
  }

  function updateChart(feeds) {
    const rows = feeds
      .map(f => ({
        t: f.created_at,
        temp: parseNum(f.field1),
        hum:  parseNum(f.field2),
      }))
      .filter(r => r.temp !== null && r.hum !== null);

    chart.data.labels = rows.map(r => new Date(r.t).toLocaleTimeString());
    chart.data.datasets[0].data = rows.map(r => r.temp);
    chart.data.datasets[1].data = rows.map(r => r.hum);
    chart.update();
  }

  async function refresh() {
    try {
      const feeds = await loadFeeds();
      updateMapRoute(feeds);
      updateChart(feeds);

      const last = await loadLast();
// ====== ESTADO DEL ROBOT ======
const lastSeen = last.created_at;
const sats = parseNum(last.field5); // satÃ©lites
const hdop = parseNum(last.field6); // hdop

if (lastSeen) {
  const lastMs = Date.parse(lastSeen);
  const ageSec = (Date.now() - lastMs) / 1000;

  let stateText = "ðŸŸ¢ ACTIVO";
  let stateColor = "#22c55e";

  if (ageSec > 60) { stateText = "ðŸŸ¡ RETRASADO"; stateColor = "#eab308"; }
  if (ageSec > 180) { stateText = "ðŸ”´ SIN DATOS"; stateColor = "#ef4444"; }

  const rs = document.getElementById("robotState");
  rs.textContent = stateText;
  rs.style.color = stateColor;

  document.getElementById("lastUpdate").textContent =
    `${new Date(lastSeen).toLocaleString()} (${Math.round(ageSec)}s atrÃ¡s)`;
}

// GPS info
document.getElementById("gpsSats").textContent = sats ?? "â€”";
document.getElementById("gpsHdop").textContent = hdop ?? "â€”";

const q = gpsQualityFromHdop(hdop);
const gs = document.getElementById("gpsState");
gs.textContent = q.label;
gs.style.color = q.color;
      const lat = parseNum(last.field3);
      const lon = parseNum(last.field4);

      document.getElementById('status').textContent =
        `Ãšltima muestra: ${last.created_at} | Lat: ${lat?.toFixed(6)} Lon: ${lon?.toFixed(6)}`;
    } catch (e) {
      document.getElementById('status').textContent =
        `Error leyendo ThingSpeak (si es CORS, hacemos proxy): ${e.message}`;
    }
  }

  refresh();
  setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>

